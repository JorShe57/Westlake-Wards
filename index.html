<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Westlake Ward Map</title>
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 0;
    }
    
    /* Map Styles */
    #map {
      height: 80vh;
      width: 100%;
      position: relative;
    }

    /* Button Container */
    .button-container {
      position: absolute;
      top: 15px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
    }

    /* Find My Ward Button */
    #find-ward-btn {
      background-color: #3c9a3c;
      color: white;
      padding: 10px 15px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      box-shadow: 2px 4px 10px rgba(0, 0, 0, 0.2);
      transition: background 0.3s ease;
    }

    #find-ward-btn:hover {
      background-color: #2a7a2a;
    }

    /* Popup Styling */
    .popup-content {
      text-align: center;
      font-size: 14px;
    }

    .popup-content img {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      margin-bottom: 10px;
    }

    .popup-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
    }

    .popup-buttons a {
      text-decoration: none;
      padding: 6px 12px;
      font-size: 14px;
      border-radius: 5px;
      color: white;
      background: #3c9a3c;
      transition: 0.3s;
    }

    .popup-buttons a:hover {
      background: #2a7a2a;
    }
  </style>
</head>
<body>

  <!-- "Find My Ward" Button -->
  <div class="button-container">
    <button id="find-ward-btn" disabled>Find My Ward</button>
  </div>

  <!-- Map Container -->
  <div id="map"></div>

  <!-- Leaflet & Turf.js -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/@turf/turf"></script>

  <script>
    // Initialize Map
    const map = L.map('map').setView([41.445, -81.926], 12);

    // Base Layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Council Members Data
    const councilMembers = {
      "1": { name: "Duane Van Dyke", email: "dvandyke@cityofwestlake.org", phone: "4402411817", img: "https://cmsv2-assets.apptegy.net/uploads/27369/file/4291769/e53aec77-39bc-4dd1-9073-522ab4198351.jpeg" },
      "2": { name: "Nick Nunnari", email: "nnunnari@cityofwestlake.org", phone: "4402632215", img: "https://cmsv2-assets.apptegy.net/uploads/27369/file/4291783/faababc0-db81-452f-ac9c-f582ddcb5164.jpeg" },
      "3": { name: "Dennis Sullivan", email: "dsullivan@cityofwestlake.org", phone: "4408358661", img: "https://cmsv2-assets.apptegy.net/uploads/27369/file/4291965/896c1717-e64f-41ba-8621-799a8f3edf40.jpeg" },
      "4": { name: "Michael O'Donnell", email: "modonnell@cityofwestlake.org", phone: "4407810257", img: "https://cmsv2-assets.apptegy.net/uploads/27369/file/4291971/a1957baf-0641-4d89-9f90-0a57503cc391.jpeg" },
      "5": { name: "Amy Havelka", email: "ahavelka@cityofwestlake.org", phone: "4404826800", img: "https://cmsv2-assets.apptegy.net/uploads/27369/file/4291983/c95be0eb-1694-4275-89fa-6a08038961b3.jpeg" },
      "6": { name: "Mark Getsay", email: "mgetsay@cityofwestlake.org", phone: "4403607418", img: "https://cmsv2-assets.apptegy.net/uploads/27369/file/4291991/b7a9d23f-e632-44be-a14a-5ce88659d9cd.jpeg" }
    };

    let wardLayer;
    fetch("https://raw.githubusercontent.com/JorShe57/Westlake-Wards/main/wards.geojson")
      .then(res => res.json())
      .then(data => {
        wardLayer = L.geoJSON(data, {
          style: { color: "blue", weight: 2, fillOpacity: 0.2 },
          onEachFeature: (feature, layer) => {
            let wardNum = feature.properties.Ward;
            if (councilMembers[wardNum]) {
              let member = councilMembers[wardNum];
              layer.bindPopup(`
                <div class="popup-content">
                  <img src="${member.img}" alt="${member.name}">
                  <h2>${member.name}</h2>
                  <h3>Ward ${wardNum}</h3>
                  <div class="popup-buttons">
                    <a href="mailto:${member.email}">Email</a>
                    <a href="tel:${member.phone}">Call</a>
                  </div>
                </div>
              `);
            }
          }
        }).addTo(map);

        document.getElementById("find-ward-btn").disabled = false; // Enable button when GeoJSON loads
      });

    document.getElementById("find-ward-btn").addEventListener("click", () => {
      if (!navigator.geolocation) {
        alert("Geolocation is not supported by your browser.");
        return;
      }

      navigator.geolocation.getCurrentPosition(position => {
        const userCoords = [position.coords.longitude, position.coords.latitude];
        let userPoint = turf.point(userCoords);

        // Drop user location pin
        let userMarker = L.marker([userCoords[1], userCoords[0]]).addTo(map)
          .bindPopup("<b>You are here</b>").openPopup();

        // Check which ward contains the user
        let foundWard = wardLayer.toGeoJSON().features.find(feature => {
          return turf.booleanPointInPolygon(userPoint, feature.geometry);
        });

        if (foundWard) {
          let wardNum = foundWard.properties.Ward;
          let member = councilMembers[wardNum];

          // Find ward layer and trigger popup
          wardLayer.eachLayer(layer => {
            if (layer.feature.properties.Ward == wardNum) {
              layer.openPopup();
            }
          });

          userMarker.bindPopup(`
            <b>You are in Ward ${wardNum}</b><br>
            <strong>${member.name}</strong>
          `).openPopup();
        } else {
          userMarker.bindPopup("You are not in a defined ward area.").openPopup();
        }

      }, error => {
        alert("Unable to retrieve location. Make sure location access is allowed.");
      });
    });

  </script>
</body>
</html>
